---
title: "CODECHECK: Piccolo2020"
author: "Stephen J Eglen"
date: "`r Sys.Date()`"
always_allow_html: true
output:
  pdf_document:
    toc: true
    highlight: zenburn
    includes:
       in_header: preamble.sty
  html_document:
    self_contained: false
    toc: true
    toc_float: false
---

```{r rsetup-knitr,eval=TRUE,include=FALSE}
require(knitr)
require(DT)
require(yaml)
require(tibble)
require(readr)
options(width=60)
opts_chunk$set(cache=FALSE)

root_project = "../" #root of directory relative to this file.
dest_dir = "outputs/"

outputs_manifest = paste0(root_project, "codecheck-manifest.yml")


outputs_manifest = read_yaml(outputs_manifest)

## Create the outputs directory if missing
if ( !dir.exists(dest_dir) ) {
  dir.create(dest_dir)
}

## Copy each file mentioned in the manifest into DEST_DIR
dest_files = sapply(outputs_manifest, function(x) {
  src_file  = paste0(root_project, x$file)
  dest_file  = paste0(dest_dir,    basename(x$file))
  file.copy(src_file, dest_file)
  dest_file
})
  
get_outputs = function(outputs_manifest) {
  files = sapply(outputs_manifest, function(x) x$file)
  comments = sapply(outputs_manifest, function(x) x$comment)
  ##sizes = sapply(files, function(f) file.size(sprintf("%s%s", dir, f)))
  sizes = file.size(dest_files)
  url=sprintf('<a href="%s">%s</a>', dest_files, files)
  table = cbind(files, comments, sizes, url)
  table
}
```



# Piccolo2020


The paper checked was the second revision of the manuscript by Piccolo
et al (2020), now in press at the journal *Gigascience*.  A preprint
of the initial submission is available at:
<https://www.biorxiv.org/content/10.1101/675181v1>

**Scott: would it be possible sometimes to archive the version of the
paper that was code-checked?**


The main repository of the paper contained code to apply machine
learning techniques to datasets; this code would take hours-days to
run, and so for now has not been re-run.  The code that has been
checked is the code that takes the intermediate outputs from the
machine learning and visualises those results.  **This codecheck does
not (yet) re-run the entire pipeline.**


## Summary of outputs generated
```{r, echo=FALSE}
outputs = get_outputs(outputs_manifest)
##datatable(outputs, rownames=FALSE,
##		   escape=1, options=list(pageLength=25), caption = "Captured Outputs")
kable(outputs[,1:3])
```

**CODECHECK status: PASS.**  All figures in main manuscript could be
regenerated.  

Signed: Stephen J Eglen <https://orcid.org/0000-0001-8607-8025>.  2020-02-05.

\clearpage
# CODECHECKER notes.


### Data and Code

After creating an empty repository, the following data and results
folders were copied from CODE OCEAN capsule for the paper: `Datasets`,
`Results_Basic`, `Results_FeatureSelection` and
`Results_ParamsOptimized`.  One of the data files
`Results_ParamsOptimized/diabetes/Nested_Predictions.tsv.gz` needed to
be compressed to reduce the file size from 160 Mb to 9 Mb (Github has
limit on individual files of 100 Mb.)


The main Rmd and helper script were downloaded from
<https://github.com/srp33/ShinyLearner/>.  The Rmd file was edited to
read the compressed version of the .tsv file.

### Extra software installations



To run this script, I needed to install the following R packages

```{r eval=FALSE}
install.packages("tidyverse")
install.packages("cowplot")
```

### Running the software to regenerate outputs.

A few small edits were made to the `Analyze_Results.Rmd`, see the git
history,

To regenerate the Figures/ folder, we simply ran `make run` in the
Makefile, created by SJE.


\clearpage

# Outputs

Perhaps yml should note which files should be shown in the
certificate?  By default, figures could be included with
*include_graphics* and data frames could be summarised by the tibble.

## TODO -- this could be generated by a child chunk?
```{r pressure, echo=FALSE, fig.cap=outputs[1:6,"comments"]}
knitr::include_graphics(dest_files[1])
cat('\n\n')
knitr::include_graphics(dest_files[2])
cat('\n\n')
knitr::include_graphics(dest_files[3])
cat('\n\n')
knitr::include_graphics(dest_files[4])
cat('\n\n')
knitr::include_graphics(dest_files[5])
cat('\n\n')
knitr::include_graphics(dest_files[6])
cat('\n\n')
```

```{r tab.cap="Table 1"}
read_tsv(dest_files[7])
```

\clearpage

```{r tab.cap="Table 2"}
read_tsv(dest_files[8])
```



